{"aid": "40054580", "title": "usbredir: A protocol for sending USB device traffic over a network connection", "url": "https://www.spice-space.org/usbredir.html", "domain": "spice-space.org", "votes": 4, "user": "sipofwater", "posted_at": "2024-04-16 17:13:59", "comments": 2, "source_title": "usbredir", "source_text": "usbredir\n\n# usbredir\n\nusbredir is the name of a network protocol for sending USB device traffic over\na network connection. It is also the name of the software package offering a\nparsing library, a usbredirhost library and several utilities implementing\nthis protocol.\n\nThe protocol is documented here, this document also explains what is meant\nwith a usbhost and a usbguest.\n\nusbredir was created for use with Spice, which is why it is hosted on spice-\nspace.org, but the protocol and the usbredirhost are completely independent of\nspice, they could for example also be used to create a vnc extension for\nredirecting USB devices over a vnc connection to a qemu virtual machine.\n\nThe usbguest side is currently only implemented for qemu, and shipped as part\nof qemu (enabling this in qemu requires the libusbredirparser library to be\navailable when building qemu).\n\nusbredir supports USB device filtering configurable by a filter string\n\n## Host Configuration\n\nFor redirection to work, the virtual machine must have a supported USB\ncontroller. Qemu supports both USB2 and USB3, but at the time of writing, USB3\nhas had less testing. For USB2 support, the guest must have a EHCI controller\nand companion UHCI controller (companion UHCI is needed in order to support\nalso USB1.x devices). For USB3 support, an XHCI controller is required. It\nalso needs to have Spice channels for USB redirection. The number of such\nchannels determine the number of USB devices that it's possible to redirect at\nthe same time.\n\nMore information about USB controllers in qemu could be found here.\n\n### Using virt-manager\n\nVirtual machines created with virt-manager should have a USB controller by\ndefault. In the virtual machine details, select \"Controller USB\" in the left\npane. If you only need to support USB2 devices, make sure its model is set to\n\"USB2\". For USB 3.0 support, select \"USB3\" for the model type.\n\nYou can then click on \"Add Hardware\" and add \"USB Redirection\" items as the\nnumber of USB devices you want to be able to redirect simultaneously.\n\n### Using libvirt\n\nThe following libvirt XML will configure a guest with USB2 support and the\nability to redirect 3 devices simultaneously:\n\n    \n    \n    <controller type='usb' index='0' model='ich9-ehci1'/> <controller type='usb' index='0' model='ich9-uhci1'> <master startport='0'/> </controller> <controller type='usb' index='0' model='ich9-uhci2'> <master startport='2'/> </controller> <controller type='usb' index='0' model='ich9-uhci3'> <master startport='4'/> </controller> <redirdev bus='usb' type='spicevmc'/> <redirdev bus='usb' type='spicevmc'/> <redirdev bus='usb' type='spicevmc'/>\n\nFor USB3 support, the configuration can be simplified to:\n\n    \n    \n    <controller type='usb' index='0' model='nec-xhci'/> <redirdev bus='usb' type='spicevmc'/> <redirdev bus='usb' type='spicevmc'/> <redirdev bus='usb' type='spicevmc'/>\n\n### Using QEMU\n\nThe following qemu options will configure a guest with USB2 support and the\nability to redirect 3 devices simultaneously\n\n    \n    \n    -device ich9-usb-ehci1,id=usb \\ -device ich9-usb-uhci1,masterbus=usb.0,firstport=0,multifunction=on \\ -device ich9-usb-uhci2,masterbus=usb.0,firstport=2 \\ -device ich9-usb-uhci3,masterbus=usb.0,firstport=4 \\ -chardev spicevmc,name=usbredir,id=usbredirchardev1 \\ -device usb-redir,chardev=usbredirchardev1,id=usbredirdev1 \\ -chardev spicevmc,name=usbredir,id=usbredirchardev2 \\ -device usb-redir,chardev=usbredirchardev2,id=usbredirdev2 \\ -chardev spicevmc,name=usbredir,id=usbredirchardev3 \\ -device usb-redir,chardev=usbredirchardev3,id=usbredirdev3\n\nFor USB3 support, the configuration can be simplified to:\n\n    \n    \n    -device nec-usb-xhci,id=usb \\ -chardev spicevmc,name=usbredir,id=usbredirchardev1 \\ -device usb-redir,chardev=usbredirchardev1,id=usbredirdev1 \\ -chardev spicevmc,name=usbredir,id=usbredirchardev2 \\ -device usb-redir,chardev=usbredirchardev2,id=usbredirdev2 \\ -chardev spicevmc,name=usbredir,id=usbredirchardev3 \\ -device usb-redir,chardev=usbredirchardev3,id=usbredirdev3\n\n## Client Configuration\n\nThe client needs to have support for USB redirection. In remote-viewer, you\ncan select which USB devices to redirect under the \"File->USB device\nselection\" menu once the Spice connection is established. There are also\nvarious command line redirection options which are described below and when\nrunning remote-viewer with --help-spice.\n\nTo get USB redirection working on Windows clients, you need to install UsbDk\n\n## Filter String Format\n\nA filter is used to set blocking or autoconnect rules for USB devices. It\nconsists of one or more rules, where each rule has the form of:\n\n<class>,<vendor>,<product>,<version>,<allow>\n\nUse -1 for class/vendor/product/version to accept any value.\n\nAnd the rules themselves are concatenated like this:\n\nrule1|rule2|rule3\n\nA client's default auto-connect filter string is 0x03,-1,-1,-1,0|-1,-1,-1,-1,1\n\nThis filters out HID (class 0x03) USB devices from auto connect and auto\nconnects anything else. Note the explicit allow rule at the end, this is\nnecessary since by default all devices without a matching filter rule will not\nauto-connect.\n\n## Client Filtering\n\nSet a string specifying a filter to determine which USB devices, when plugged\nin, are allowed/blocked to auto-redirect USB traffic to the guest (client's\nwindow has to be in focus).\n\n    \n    \n    remote-viewer --spice-usbredir-auto-redirect-filter=\"0x03,-1,-1,-1,0|-1,-1,-1,-1,1\"\n\nSet a string specifying a filter to determine which USB devices, that are\nalready plugged in, to redirect on connect once Spice connection is\nestablished.\n\n    \n    \n    remote-viewer --spice-usbredir-redirect-on-connect=\"0x03,-1,-1,-1,0|-1,-1,-1,-1,1\"\n\n## Host Filtering\n\nSet a string specifying a filter to determine which USB devices are\nallowed/blocked to redirect USB traffic to the guest.\n\n### Using QEMU\n\n    \n    \n    -device usb-redir,filter='0x03:-1:-1:-1:0|-1:-1:-1:-1:1',chardev=usbredirchardev1,id=usbredirdev1\n\nNote that in a QEMU command, the filter string should use a ':' character as a\nseparator within the rule.\n\n### Using libvirt\n\n    \n    \n    ... <devices> ... <redirfilter> <usbdev class='0x08' vendor='0x1234' product='0xbeef' version='2.56' allow='yes'/> <usbdev allow='no'/> </redirfilter> </devices> ...\n\n## Download\n\nLatest versions:\n\n  * For use with qemu 1.3 and newer: usbredir-0.7.1.tar.bz2\n  * For use with qemu 1.0 / 1.1 / 1.2 release: usbredir-0.4.4.tar.bz2\n\nOlder versions: 0.7, 0.6, 0.5.2, 0.5.1, 0.5, 0.4.3, 0.4.2, 0.4.1, 0.4, 0.3.3,\n0.3.2, 0.3.1, 0.3\n\n### sourcecode\n\nYou can find the official usbredir git repository here.\n\n", "frontpage": true}
