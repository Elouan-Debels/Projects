{"aid": "40007242", "title": "Ubuntu bug \"CIFS stopped working with kernel update \"", "url": "https://bugs.launchpad.net/ubuntu/+source/linux/+bug/2060780", "domain": "launchpad.net", "votes": 1, "user": "todsacerdoti", "posted_at": "2024-04-11 21:56:06", "comments": 0, "source_title": "Bug #2060780 \u201cCIFS stopped working/is unstable with kernel updat...\u201d : Bugs : linux package : Ubuntu", "source_text": "Bug #2060780 \u201cCIFS stopped working/is unstable with kernel updat...\u201d : Bugs :\nlinux package : Ubuntu\n\nLog in / Register\n\n## Ubuntu linux package\n\n  * Overview\n  * Code\n  * Bugs\n  * Blueprints\n  * Translations\n  * Answers\n\n# CIFS stopped working/is unstable with kernel update to 5.15.0-102.112\n\nBug #2060780 reported by Andreas Besold on 2024-04-10\n\n66\n\nThis bug affects 13 people\n\nAffects| Status| Importance| Assigned to| Milestone  \n---|---|---|---|---  \nlinux (Ubuntu)| Confirmed| Undecided| Unassigned  \nJammy| Fix Committed| High| Unassigned  \n  \n### Bug Description\n\nHi,\n\nupdated some Ubuntu 22.04 systems to lastest available state this morning,\nwhich caused CIFS mounts (from various fileservers) to stop working. Kernel\nwas updated to version 5.15.0-102-generic.\n\nI can mount the shares without problems (mount -t cifs), but then, df for\nexample tells me: df: /mnt: Resource temporarily unavailable. I'm able to list\nand browse all the files, but accessing them (even readonly) is very unstable.\nSometimes it works and sometimes it just gives me i/o errors.\n\nSwitching back to 5.15.0-101-generic or 5.15.0-100-generic solves the problem\nand everything works again as expected.\n\nSeems like some bug has been implemented in 5.15.0-102-generic...\n\nTo reproduce the problem, I started a while loop on one server to write to\nsome file on a specific mounted CIFS share and read it from another one\n\nroot@<hostname1>:~# while true; do echo \"$(date) hallo\" >> /mnt/hallo.txt;\nsleep 1 ; done -bash: /mnt/hallo.txt: Input/output error -bash:\n/mnt/hallo.txt: Input/output error ^C\n\nroot@<hostname2>:~$ tail -f /mnt/hallo.txt Tue Apr 9 04:10:52 PM CEST 2024\nhallo Tue Apr 9 04:10:53 PM CEST 2024 hallo Tue Apr 9 04:10:54 PM CEST 2024\nhallo Tue Apr 9 04:10:55 PM CEST 2024 hallo Tue Apr 9 04:10:56 PM CEST 2024\nhallo Tue Apr 9 04:10:57 PM CEST 2024 hallo Tue Apr 9 04:10:58 PM CEST 2024\nhallo Tue Apr 9 04:10:59 PM CEST 2024 hallo Tue Apr 9 04:11:00 PM CEST 2024\nhallo Tue Apr 9 04:11:01 PM CEST 2024 hallo tail: cannot determine location of\n'/mnt/hallo.txt'. reverting to polling: Resource temporarily unavailable Tue\nApr 9 04:11:04 PM CEST 2024 hallo Tue Apr 9 04:11:05 PM CEST 2024 hallo Tue\nApr 9 04:11:06 PM CEST 2024 hallo Tue Apr 9 04:11:07 PM CEST 2024 hallo Tue\nApr 9 04:11:08 PM CEST 2024 hallo Tue Apr 9 04:11:09 PM CEST 2024 hallo Tue\nApr 9 04:11:10 PM CEST 2024 hallo\n\nWhile doing this, both servers tell me, the resource is unavailable\n\nroot@<hostname1>:~# df -h /mnt df: /mnt: Resource temporarily unavailable\n\nroot@<hostname2>:~$ df -h /mnt df: /mnt: Resource temporarily unavailable\n\nTags: seg\n\nRevision history for this message\n\nAndreas Besold (absld) wrote on 2024-04-10:| #1  \n---|---  \n  \nSee related question\n\nRevision history for this message\n\nAxel Schneck (aschneckubuntu) wrote on 2024-04-10:| #2  \n---|---  \n  \nSame problems here. Get error messages like \"Too many symlinks\" and exactly\nthe same as in this description. Found also, that CIFS mounts to Netapp mostly\nworks, but df -h doesnt show them and mounts to other CIFS shares doesnt work.\nVerified it on 5 Linux Boxes, all started failing after patch and working\nagain when go back to snapshot from yesterday (before kernel patch): These\npatches are he \"bad ones\":\n\nStart-Date: 2024-04-09 06:21:54 Commandline: /usr/bin/unattended-upgrade\nInstall: linux-image-5.15.0-102-generic:amd64 (5.15.0-102.112, automatic),\nlinux-modules-5.15.0-102-generic:amd64 (5.15.0-102.112, automatic), linux-\nheaders-5.15.0-102:amd64 (5.15.0-102.112, automatic), linux-modules-\nextra-5.15.0-102-generic:amd64 (5.15.0-102.112, automatic), linux-\nheaders-5.15.0-102-generic:amd64 (5.15.0-102.112, automatic) Upgrade: linux-\nheaders-generic:amd64 (5.15.0.101.98, 5.15.0.102.99), linux-generic:amd64\n(5.15.0.101.98, 5.15.0.102.99), linux-image-generic:amd64 (5.15.0.101.98,\n5.15.0.102.99) End-Date: 2024-04-09 06:22:23\n\nStart-Date: 2024-04-09 06:22:26 Commandline: /usr/bin/unattended-upgrade\nRemove: linux-modules-5.15.0-101-generic:amd64 (5.15.0-101.111), linux-\nmodules-extra-5.15.0-101-generic:amd64 (5.15.0-101.111), linux-\nimage-5.15.0-101-generic:amd64 (5.15.0-101.111) End-Date: 2024-04-09 06:22:30\n\nStart-Date: 2024-04-09 06:22:33 Commandline: /usr/bin/unattended-upgrade\nRemove: linux-headers-5.15.0-101-generic:amd64 (5.15.0-101.111) End-Date:\n2024-04-09 06:22:34\n\nStart-Date: 2024-04-09 06:22:36 Commandline: /usr/bin/unattended-upgrade\nRemove: linux-headers-5.15.0-101:amd64 (5.15.0-101.111) End-Date: 2024-04-09\n06:22:37\n\nRevision history for this message\n\nLaunchpad Janitor (janitor) wrote on 2024-04-10:| #3  \n---|---  \n  \nStatus changed to 'Confirmed' because the bug affects multiple users.\n\nChanged in linux (Ubuntu):  \n---  \nstatus:| New \u2192 Confirmed  \n  \nRevision history for this message\n\nBenjamin Richner (benri) wrote on 2024-04-10:| #4  \n---|---  \n  \nI collected a bunch of info on it. Seems to be reported all over the place:\n\n\\-\nhttps://www.reddit.com/r/linux/comments/1bzvy5l/ubuntu_22044_latest_updates_492024_break_cifssmb/\n-\nhttps://www.reddit.com/r/Ubuntu/comments/1bzshdt/ubuntu_2204_smb_shares_stopped_working_lastnight/\n- https://askubuntu.com/questions/1509987/cifs-on-22-04-lts-has-something-\nchanged-between-kernel-5-15-0-101-generic-and -\nhttps://forum.level1techs.com/t/cifs-broken-by-ubuntu-server-22-04-4-latest-\nupdates/209639 - https://forums.linuxmint.com/viewtopic.php?t=417371\n\nOh and there's also a duplicate:\nhttps://bugs.launchpad.net/ubuntu/+source/cifs-utils/+bug/2060797\n\nThe most promising lead is this:\n\n> Looks like there's a fix that's yet to make it to Linux Mint and Ubuntu\n> kernels: > > [PATCH 5.15.y 0/1] smb: client: fix \"df: Resource temporarily\n> unavailable\" on 5.15 stable kernel > https://<email address hidden>/T/\n\nMany people are affected.\n\nMatthew Ruffell (mruffell) 19 hours ago\n\nChanged in linux (Ubuntu Jammy):  \n---  \nstatus:| New \u2192 Fix Committed  \nimportance:| Undecided \u2192 High  \ntags:| added: seg  \n  \nRevision history for this message\n\nMatthew Ruffell (mruffell) wrote 19 hours ago:| #5  \n---|---  \n  \nHi everyone,\n\nReading:\n\nhttps://<email address hidden>/T/\n\nIt seems the issue was introduced in\n\ncommit 33eae65c6f49770fec7a662935d4eb4a6406d24b Author: Paulo Alcantara <email\naddress hidden> Date: Wed Dec 13 12:25:57 2023 -0300 Subject: smb: client: fix\nOOB in SMB2_query_info_init() Link:\nhttps://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=33eae65c6f49770fec7a662935d4eb4a6406d24b\n\nthis was indeed landed in 5.15.0-102-generic:\n\n$ git log --grep \"smb: client: fix OOB in SMB2_query_info_init()\"\norigin/master-next commit ed30eac9715d0bd5512ee42ca8e8f340d2d9d2d5 ...\n\n$ git describe --contains ed30eac9715d0bd5512ee42ca8e8f340d2d9d2d5\nUbuntu-5.15.0-102.112~472\n\nThe link mentions it is supposedly fixed in:\n\ncommit b5d623611c9cda84ebb5e5bd044587955eaf782f Author: Kees Cook <email\naddress hidden> Date: Fri Feb 17 16:24:40 2023 -0800 Subject: smb3: Replace\nsmb2pdu 1-element arrays with flex-arrays Link:\nhttps://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=b5d623611c9cda84ebb5e5bd044587955eaf782f\n\nLooking at the Jammy kernel tree:\n\n$ git log --grep \"smb3: Replace smb2pdu 1-element arrays with flex-arrays\"\norigin/master-next commit b5d623611c9cda84ebb5e5bd044587955eaf782f\n\n$ git describe --contains b5d623611c9cda84ebb5e5bd044587955eaf782f\nUbuntu-5.15.0-104.114~23\n\nIt seems it is already applied and tagged in 5.15.0-104-generic. This seems to\nbe built, but not quite in -proposed yet:\n\nhttps://kernel.ubuntu.com/reports/kernel-stable-board/\n\nI will write back as soon as 5.15.0-104-generic is in -proposed, with\ninstructions on how to test it, and see if it fixes the issue.\n\nThanks, Matthew\n\nRevision history for this message\n\nMatthew Ruffell (mruffell) wrote 16 hours ago:| #6  \n---|---  \n  \nHi everyone,\n\n5.15.0-104-generic just hit jammy-proposed a couple minutes ago. It isn't\navailable for focal users yet.\n\nCan someone please test 5.15.0-104-generic on jammy and let me know if it\nfixes the issue? Thanks.\n\nInstructions to Install (On a mantic system): 1) cat << EOF | sudo tee /etc/apt/sources.list.d/ubuntu-$(lsb_release -cs)-proposed.list # Enable Ubuntu proposed archive deb http://archive.ubuntu.com/ubuntu/ $(lsb_release -cs)-proposed main universe EOF 2) sudo apt update 3) sudo apt install linux-image-5.15.0-104-generic linux-modules-5.15.0-104-generic linux-modules-extra-5.15.0-104-generic linux-headers-5.15.0-104-generic 4) sudo rm /etc/apt/sources.list.d/ubuntu-$(lsb_release -cs)-proposed.list 5) sudo apt update 6) sudo reboot 5.15.0-104-generic #114-Ubuntu SMP Thu Mar 28 15:39:51 UTC 2024\n\nJust a note that 5.15.0-104-generic is a part of the 2024.04.01 SRU cycle, and\nwill likely be released at the end of month, as per\nhttps://kernel.ubuntu.com/, and won't be coming out any sooner.\n\nThanks, Matthew\n\nRevision history for this message\n\nengaging374 (engaging374) wrote 15 hours ago:| #7  \n---|---  \n  \nHello Matthew,\n\nI tested it with 22.04.4 LTS.\n\nLinux srv1 5.15.0-104-generic #114-Ubuntu SMP Thu Mar 28 15:39:51 UTC 2024\nx86_64 x86_64 x86_64 GNU/Linux\n\n'df -hT /opt/test'\n\nFilesystem Type Size Used Avail Use% Mounted on //cifssrv/clone1 cifs 9.5G\n4.4G 5.2G 46% /opt/test\n\n-> No 'Resource temporarily unavailable' error\n\nI still have an error in 'dmesg | grep -i cifs'\n\n[ 17.961962] CIFS: Attempting to mount \\\\\\cifssrv\\clone1 [ 18.048245] CIFS:\nVFS: parse_server_interfaces: malformed interface info\n\nNot sure if this is related to the bug.\n\nRevision history for this message\n\nBenjamin Richner (benri) wrote 14 hours ago:| #8  \n---|---  \n  \n> Just a note that 5.15.0-104-generic is a part of the 2024.04.01 SRU cycle,\n> and will likely be released at the end of month, as per\n> https://kernel.ubuntu.com/, and won't be coming out any sooner.\n\nDo I understand this correctly, do you keep kernel update 5.15.0-102.112 in\nplace and let people update into a kernel that breaks SMB/CIFS for almost an\nentire month? Isn't that dangerous? I manage a bunch of Ubuntu servers and I\nhad to instruct people to hold off on all Ubuntu updates immediately as not to\nbreak all the file shares, which would be very disruptive to our operations.\n\nRevision history for this message\n\nAxel Schneck (aschneckubuntu) wrote 13 hours ago:| #9  \n---|---  \n  \nHello,\n\nI just tested your suggestion wit 104 It's working here with this kernel Dont\nunderstand why you will still provide a faulty kernel until end of month? We\nhave a lot of servers here using CIFS mounts and we have to prevent all of\nthem now from getting a faulty kernel. bye Axel\n\nSee full activity log\n\nTo post a comment you must log in.\n\n  * Report a bug\n\nThis report contains Public information\n\nEveryone can see this information.\n\n## Duplicates of this bug\n\n  * Bug #2060797\n\nYou are not directly subscribed to this bug's notifications.\n\nSubscribing...\n\n  * Edit bug mail\n\n## Other bug subscribers\n\nSubscribe someone else\n\n### Notified of all changes\n\n  * Andreas Besold\n  * Axel Schneck\n  * Benjamin Richner\n  * Chris Patterson\n  * Haluk \u00d6gec\n  * SWick\n  * Thomas Angert\n  * mgi DevOps\n\n### Notified when the bug is closed or reopened\n\n  * Tim Dee\n\n### May be notified\n\n  * Abalan\n  * Adriano Pangione\n  * Alejandro J. Alva...\n  * Andy Whitcroft\n  * Ashani Holland\n  * Bruno Garcia\n  * CRC\n  * Calub\n  * Carles\n  * Charlie_Smotherman\n  * Christian R\u00fcger\n  * Cold\n  * Craig Miller\n  * Cyrus Lien\n  * Debian PTS\n  * Doraann2\n  * Franko Fang\n  * Gavin Guo\n  * Guido\n  * H.P.J. Groeneweg\n  * HaySayCheese\n  * Hidagawa\n  * Hui Wang\n  * Jan Florkowski\n  * Jesse Jones\n  * Joel Robison\n  * John Jack\n  * Joost\n  * Joseph Salisbury\n  * Jos\u00e9 Alfonso\n  * Keng-Yu Lin\n  * Kernel Packages\n  * MarcMiralles\n  * Marcelo Cerri\n  * Marius Vlad\n  * Matija Marinic\n  * Matt j\n  * Michael Rowland H...\n  * Ming Lei\n  * Mr. MInhaj\n  * Name Changed\n  * PCTeacher012\n  * Paolo Topa\n  * Patrick Vavrina\n  * Peter Bullert\n  * Punnsa\n  * Richard Seguin\n  * Richard Williams\n  * Solved\n  * Thomas Martin\n  * Tim Gardner\n  * Tom Weiss\n  * Tuxsimon\n  * Ubuntu Bugs\n  * Vasanth\n  * Vic Parker\n  * Web For Future INC\n  * Wer Wie Was\n  * Woodrow Shen\n  * XxEarthxX\n  * Yang Kun (YK)\n  * You-Sheng Yang\n  * Yujin.Wu\n  * Zakhid Abduldeyanov\n  * ahepas\n  * basilisgabri\n  * david\n  * dsfkj dfjx\n  * eoininmoran\n  * ganesh\n  * joe\n  * keubu\n  * linuxgijs\n  * majid hussain\n  * nikonikic42\n  * nobin\n  * praveen reddy somu\n  * projevie@hotmail.com\n  * qadir\n  * sankaran\n  * scholl.w@bridge.com\n  * stevecs\n  * van\n\n## Related questions\n\n  * linux in Ubuntu: CIFS stopped working/is unstable with kernel update to 5.15.0-102.112\n\n## Remote bug watches\n\nBug watches keep track of this bug in other bug trackers.\n\n\u2022 Take the tour \u2022 Read the guide\n\n\u00a9 2004 Canonical Ltd. \u2022 Terms of use \u2022 Data privacy \u2022 Contact Launchpad\nSupport \u2022 Blog \u2022 Careers \u2022 System status \u2022 67d34a1 (Get the code!)\n\n", "frontpage": false}
