{"aid": "39998346", "title": "Going in circles without a real-time clock", "url": "https://rachelbythebay.com/w/2024/04/10/rtc/", "domain": "rachelbythebay.com", "votes": 3, "user": "X-Cubed", "posted_at": "2024-04-11 04:22:04", "comments": 0, "source_title": "Going in circles without a real-time clock", "source_text": "Going in circles without a real-time clock\n\n# Writing\n\nSoftware, technology, sysadmin war stories, and more.\n\nWednesday, April 10, 2024\n\n## Going in circles without a real-time clock\n\nI have a story about paper cuts when using a little Linux box.\n\nOne of my sites has an older Raspberry Pi installed in a spot that takes some\neffort to access. A couple of weeks ago, it freaked out and stopped allowing\nremote logins. My own simple management stuff was still running and was\nreporting that something was wrong, but it wasn't nearly enough detail to find\nout exactly what happened.\n\nI had to get a console connected to it in order to find out that it was\nfreaking out about its filesystem because something stupid had apparently\nhappened to the SD card. I don't know exactly why it wouldn't let me log in.\nBack in the old days, you could still get into a machine with a totally dead\ndisk as long as enough stuff was still in the cache - inetd + telnetd + login\n+ your shell, or sshd + your shell and (naturally) all of the libraries those\nthings rely on. I guess something happened and some part of the equation was\nmissing. There are a LOT more moving parts these days, as we've been learning\nwith the whole xz thing. Whatever.\n\nSo I rebooted it, and went about my business, and it wasn't until a while\nlater that I noticed the thing's clock was over a day off. chrony was running,\nso WTF, right? chrony actually said that it had no sources, so it was just\nsitting there looking sad.\n\nThis made little sense to me, given that chrony is one of the more clueful\nprograms which will keep trying to resolve sources until it gets enough to\nfeel happy about using them for synchronization. In the case of my stock\ninstall, that meant it was trying to use 2.debian.pool.ntp.org.\n\nI tried to resolve it myself on the box. It didn't work. I queried another\nresolver (on another box) and it worked fine. So now what, on top of chrony\nnot working, unbound wasn't working too?\n\nA little context here: this box was reconfigured at some point to run its own\nrecursive caching resolver for the local network due to some other (*cough*\nTP-Link *cough*) problems I had last year. It was also configured to *only*\nuse that local unbound for DNS resolution.\n\nThis started connecting some of the dots. chrony wasn't setting the clock\nbecause it couldn't resolve hosts in the NTP pool. It couldn't resolve hosts\nbecause unbound wasn't working. But, okay, why wasn't unbound working?\n\nWell, here's the problem - it *mostly* was. I could resolve several other\ndomains just fine. It's just that ntp.org stuff wasn't happening.\n\n(This is where you start pointing at the screen if this has happened to you\nbefore.)\n\nSo, what would make only some domains not resolve... but not all of them... on\na box... with a clock that's over a day behind?\n\nYeah, that's about when it fit together. I figured they must be running DNSSEC\non that zone (or some part of it), and it must have a \"not-before\" constraint\non some aspect of it. I've been down this road before with SSH certificates,\nso why not DNS?\n\nI added another resolver to resolv.conf, then chrony started working, and that\nbrought the time forward, and then unbound started resolving the pool, and\neverything else returned to normal.\n\nBy \"everything else\", I also mean WireGuard. Did you know that if your machine\ngets far enough out of sync, that'll stop working, too? I had no idea that it\napparently includes time in its crypto stuff, but what other explanation is\nthere?\n\nBacking up, let's talk about what happened, because most of this is on me.\n\nI have an old Pi running from an SD card. It freaked out. It took me about a\nday and a half to get to where it was so I could start working on fixing it.\n\nThis particular Pi doesn't have a real-time clock. The very newest ones (5B)\n*do*, but you have to actually buy a battery and connect it. By default, they\nare in the same boat. This means when they come up, they use some nonsense\ntime for a while. I'm not sure exactly what that is offhand, because...\n\nsystemd does something of late where it will try to put the clock back to\nsomewhere closer to \"now\" when it detects a value that's too far in the past.\nI suspect it just digs around in the journal, grabs the last timestamp from\nthat, and runs with it. This is usually pretty good, since if you're just\ndoing a commanded reboot, the difference is a few seconds, and your time sync\nstuff fixes the rest not long thereafter.\n\nBut, recall that the machine sat there unable to write to its \"disk\" (SD card)\nfor well over a day, so that's the timestamp it used. If I had gotten there\nsooner, I guess it wouldn't have been so far off, but that wasn't an option.\n\nComing up with time that far off made unbound unable to resolve the ntp.org\npool servers, and that made chrony unable to update the clock... which made\nunbound unable to resolve the pool servers... which...\n\nMy own configuration choice which pointed DNS resolution only at localhost did\nthe rest.\n\nSo, what now? Well, first of all, I gave it secondary and tertiary resolvers\nso that particular DNS anomaly won't be repeated. Then I explicitly gave\nchrony a \"peer\" source of a nearby host (another Pi, unfortunately) which\nmight be able to help it out in a pinch even if the link to the outside isn't\nup for whatever reason.\n\nThere's a certain problem with thinking of these little boxes as cheap. They\nare... until they aren't. To mangle a line from jwz, a Raspberry Pi is only\ncheap if your time has no value.\n\nAs usual, this post is not a request for THE ONE to show up. If you are THE\nONE, you don't make mistakes. We know. Shut up and go away.\n\nMore writing | Contact / send feedback\n\n", "frontpage": true}
