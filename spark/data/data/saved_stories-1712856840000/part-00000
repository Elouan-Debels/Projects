{"aid": "40001019", "title": "It's far from clear how grub package updates work on Ubuntu", "url": "https://utcc.utoronto.ca/~cks/space/blog/linux/UbuntuGrubUpdateConfusion", "domain": "utcc.utoronto.ca", "votes": 2, "user": "emegeve83", "posted_at": "2024-04-11 11:31:39", "comments": 0, "source_title": "Chris's Wiki :: blog/linux/UbuntuGrubUpdateConfusion", "source_text": "Chris's Wiki :: blog/linux/UbuntuGrubUpdateConfusion\n\nChris Siebenmann :: CSpace \u00bb blog \u00bb linux \u00bb UbuntuGrubUpdateConfusion\n\nWelcome, guest.\n\n## It's far from clear how grub package updates work on Ubuntu\n\nApril 10, 2024\n\nRecently I ran across (and eventually reported) an issue on pre-beta Ubuntu\n24.04 where a grub package update would fail for systems with software RAID\nroot disks and BIOS MBR booting. The specific error was that grub-install\ncould not install the new version of GRUB's boot-time code on '/dev/md0', the\n(nominal) device of the root filesystem, reporting an error to the effect of:\n\n>\n>     grub-install: warning: File system `ext2' doesn't support embedding.\n> grub-install: warning: Embedding is not possible. GRUB can only be installed\n> in this setup by using blocklists. However, blocklists are UNRELIABLE and\n> their use is discouraged.. grub-install: error: diskfilter writes are not\n> supported. grub-install failure for /dev/md0\n\n(You can work around this by reconfiguring the grub package to use the\nunderlying disk devices, either by doing 'dpkg-reconfigure grub-pc' or by\ninstalling package updates in a manner where dpkg is allowed to ask you\nquestions. Also, this is another case of grub-install having unclear error\nmessages.)\n\nOne of the puzzling things about this entire situation is that the exact same\nconfiguration works on Ubuntu 22.04 and there are no obvious differences\nbetween 22.04 and 24.04 here. For instance, there are debconf keys for what\nthe root filesystem device is and they are exactly the same between 22.04 and\n24.04:\n\n>\n>     ; debconf-show grub-pc [...] * grub-pc/install_devices: /dev/disk/by-\n> id/md-name-ubuntu-server:0\n\nAt this point you might guess (as I did) that 'grub-install /dev/md0' works on\nUbuntu 22.04. However, it does not; it fails with the same error as in 24.04.\nSo presumably how grub-install is invoked during package updates is different\nbetween 22.04 and 24.04.\n\nAs far as I can tell, the 'grub-pc' package runs grub-install from its\n'postinst' script, which you can find in /var/lib/dpkg/info/grub-pc.postinst.\nIf you take a look at this script, you can see that it's a rather complex\nscript that is quite embedded into the general Debian package update and\ndebconf framework. If there are ways to run it as a standalone script so that\nyou can understand what it's doing, those ways aren't at all obvious. It's\nalso not obvious how the script is making or not making decisions, and the\n22.04 and 24.04 versions seem pretty similar. Nor does scanning and searching\neither version of the script provide any smoking guns in the form of, for\nexample, mentions of 'md-'.\n\n(You have to know a reasonable amount about dpkg to even find\n/var/lib/dpkg/info and know that the 'grub-pc.postinst' file is what you're\nlooking for. The dpkg manual page does mention that packages can have various\nscripts associated with them.)\n\nAll of this adds up to something that's almost impossible for ordinary people\nto troubleshoot or debug. All we can readily determine is that this worked in\nUbuntu 20.04 LTS and 22.04 LTS, and doesn't work in the pre-beta 24.04 (and\nprobably not in the beta 24.04, and most likely not in the released 24.04).\nThe mechanisms of it working and not working are opaque, buried inside several\nlayers of black boxes.\n\nPart of this opacity is that it's not even clear what Ubuntu's grub package\ndoes or is supposed to do on package update. If you run a UEFI system with\nmirrored system disks, for example, you may be a little bit surprised to find\nout that Ubuntu's grub is probably quietly updating all your EFI system\npartitions when it does package updates.\n\nPS: after much delving into things using various tools and the fact that I\nhave various scratch virtual machines available, I now believe that the answer\nis that Ubuntu 20.04 and 22.04 don't run grub-install at all when the grub\npackage (for MBR booting) is updated. This fact is casually semi-disguised in\nthe 20.04 and 22.04 grub-pc postinst script. Presumably the 20.04 and 22.04\nserver installer should have set 'grub-pc/install_devices' to a different\nvalue, but that problem was being covered up by grub-install normally not\nrunning and using that value.\n\nWritten on 10 April 2024.\n\n| \u00ab| Bash's sadly flawed smart (programmable) completion  \n---|---  \n  \nThese are my WanderingThoughts (About the blog)\n\nFull index of entries Recent comments\n\nThis is part of CSpace, and is written by ChrisSiebenmann. Mastodon: @cks\nTwitter @thatcks\n\n* * *\n\nCategories: links, linux, programming, python, snark, solaris, spam, sysadmin,\ntech, unix, web Also: (Sub)topics\n\nThis is a DWiki. GettingAround (Help)\n\nPage tools: View Source, Add Comment.\n\nAtom Syndication: Recent Comments.\n\nLast modified: Wed Apr 10 23:17:58 2024 This dinky wiki is brought to you by\nthe Insane Hackers Guild, Python sub-branch.\n\n", "frontpage": false}
