{"aid": "39983915", "title": "The challenges of building modern open source software on PowerPC Mac OS X", "url": "http://www.netbsd.org/~nia/tigersrc/", "domain": "netbsd.org", "votes": 16, "user": "hollimolli", "posted_at": "2024-04-09 20:30:56", "comments": 8, "source_title": "pkgsrc packages for Mac OS X 10.4 (PowerPC)", "source_text": "pkgsrc packages for Mac OS X 10.4 (PowerPC)\n\n# Unix software from pkgsrc for Mac OS X 10.4 (PowerPC Tiger)\n\n## Introduction\n\nPowerPC Macs were produced in huge numbers, and a lot of this hardware is\nstill viable for use today, with professional software such as Photoshop CS2\nand Propellerheads Reason. They're still good workstations, with lots of\nproductivity software, and no always-online tracking or distractions.\nOriginally, I got mine for running NetBSD, but found the pull of 20 year old\ncommercial software too tempting to resist.\n\nRegardless, how usable is Mac OS X 10.4 for Unix professionals, software\ndevelopers, and command-line junkies? A surprising amount of free software can\nstill run, often with some simple adjustments. The pkgsrc framework offers a\nplatform-netural repository with powerful frameworks that allow wide porting\nof software.\n\nPre-built PowerPC binaries for popular software are available, including\nPostgreSQL, ImageMagick, Python 3, Wget, cURL, FFmpeg, OpenSSH, OpenSSL,\nApache Web Server, nginx, yt-dlp, SDL, Midnight Commander, and many more.\n\nNote: I make no guarantees about the security or up-to-dateness of these\npackages, though I pinky promise they're better than what Tiger includes by\ndefault. No warranty. Your fridge may explode. You may find you're suddenly\nable to connect to servers that use modern encryption, with all the risks that\nentails.\n\n## How to install software\n\n### Bootstrapping\n\nDownload the bootstrap kit\n\nExtract the bootstrap kit on 10.4, set your PATH:\n\n    \n    \n    $ sudo tar -C / -xzpvf bootstrap-tiger.tar.gz $ export PATH=/usr/pkg/sbin:/usr/pkg/bin:$PATH $ export PKG_PATH=https://ftp.NetBSD.org/pub/pkgsrc/misc/nia/tigersrc/packages/All/\n\nAdd the last two lines to ~/.bash_profile.\n\n### Installing packages\n\nBrowse the repository\n\n    \n    \n    $ sudo pkg_add ffmpeg2\n\n## Challenges building modern software on 10.4\n\nPart of this project is just for fun. Since I'm a developer specialized in\nbuild systems, I get enjoyment out of pushing pkgsrc as far as possible.\nTherefore, others should get to learn from this too.\n\nRefer to the mk.conf used for this repository, containing some non-upstreamed\nworkarounds, and the allowlist of packages.\n\n  * Compiler: XCode's GCC 4.0 does not support C++11 or C11. Some software expects the compiler to default to C99, and does not explicitly specify -std=c99 in CFLAGS. This older version of GCC supports C99 but does not default to it, which should be worked around by setting FORCE_C_STD in pkgsrc. Many pieces of modern software like to specify lots of unsupported -W and -Wno arguments to customize warnings. These can be stripped out with pkgsrc's BUILDLINK_TRANSFORM.\n  * Linker: The strict Mach-O linker included in Tiger is quite different from what modern software expects (e.g. it does not support -shared), unless that software uses libtool to make shared libraries in a portable manner. pkgsrc has long had a policy of \"libtoolization\", patching software that builds with plain Makefiles to use libtool. BUILDLINK_TRANSFORM can also translate many GNU ELF-style linker arguments to be compatible with the Darwin linker. I also found the -m option (for making multiply-defined symbols into a warning instead of an error) useful.\n  * Library: Now-ubiqitious functions are missing, including clock_gettime and strnlen. These can easily be substituted from either libnbcompat or macports-legacy-support.\n  * Atomics: Some wide atomic instructions are missing from 32-bit PowerPC. This isn't a PowerPC or Darwin-specific problem, since it affects other 32-bit instruction sets like i486.\n  * Rust: Even if it worked on this platform, build times would be completely unacceptable. We use the pre-Rust versions of software like py-cryptography, since pkgsrc makes this easy. Reduce CO2 emissions, keep writing C.\n  * Locales: Certain UTF-8 file names fail to extract with bsdtar, with the UTF-8 sequences being detected as invalid. I haven't done much research into this yet, but it affects very few packages, such as the Icelandic aspell dictionary. This is probably not a bsdtar problem, since it works on NetBSD with the same tar version.\n  * Toolchain bugs: There is a problem with signal.h that causes some software to fail to compile. This can be easily worked around by disabling the relevant type definitions by pre-defining macros in CFLAGS.\n  * Kernel bugs: Sadly, kqueue does not work properly on Tiger. kqueue support is nearly always optional in software, but sometimes the detection needs to be turned off for this OS version. GNU configure makes this easy, other build systems may vary.\n  * Other curiosities: The default dashboard widgets and screensaver in 10.4 use a surprising amount of CPU time that could be better spent on GCC. They're easy to disable, though.\n\nMost of these problems are very general, so there's a lot of benefit to be\ngained from automatically making these adjustments for everything.\n\nA big problem for this project is the wider ecosystem (well, mostly GNOME-\nadjacent libraries) moving away from the GNU build system, which mostly solved\nthe problem of building shared libraries on different platforms years ago, as\nwell as nicely handling feature detection. More work needs to be done before\nCMake and Meson can work well on this platform, but also a way to say to them\n\"yes, this OS has this feature, but please ignore it\" would be very useful\n(also for testing!).\n\nRelated to the issue of 64-bit atomics is the world moving away from 32-bit\nplatforms. If you're a stranger to the embedded world, this is happening more\nslowly than you might think. While Mac OS X suffers from the Year 2038\nProblem, NetBSD solved it years ago. 64-bit wide atomic instructions are\nunavailable on many NetBSD ports, with libatomic being a hacky workaround at\nbest.\n\nMost importantly, if you maintain a C/C++ software project, and don't specify\n-std=(gnu|c)XX in your build sytem already, please do. Keep in mind that\n-Werror will fall over the moment you try building with a compiler version\nthat you haven't tested personally, and distribution maintainers will want to\ndisable it. For pkgsrc on modern platforms, at any one time we're building\nwith around 4 different major versions of GCC plus Clang, so we'd disable it\neven if we weren't supporting crusty old stuff.\n\n## See also\n\n  * MacPorts - lots of prior art\n  * TigerBrew - lots of frozen packages to prevent them breaking, pkgsrc being more \"live\"\n  * Macintosh Repository - useful for obtaining XCode\n\nnia from the domain pkgsrc.org Best viewed in Links. Last updated March 2024.\n\n", "frontpage": true}
