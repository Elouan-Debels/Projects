{"aid": "39987361", "title": "Linux Kernel Patched for Branch History Injection \"BHI\" Intel CPU Vulnerability", "url": "https://www.phoronix.com/news/Linux-BHI-Branch-History-Inject", "domain": "phoronix.com", "votes": 1, "user": "willk", "posted_at": "2024-04-10 05:50:30", "comments": 0, "source_title": "Linux Kernel Patched For Branch History Injection \"BHI\" Intel CPU Vulnerability - Phoronix", "source_text": "Linux Kernel Patched For Branch History Injection \"BHI\" Intel CPU\nVulnerability - Phoronix\n\n  * Articles & Reviews\n  * News Archive\n  * Forums\n  * Premium Ad-Free\n  * Contact\n  * Popular Categories\n  * Close\n\n  * Articles & Reviews\n  * News Archive\n  * Forums\n  * Premium\n  * Contact\n  * Categories\n\nComputers Display Drivers Graphics Cards Linux Gaming Memory Motherboards\nProcessors Software Storage Operating Systems Peripherals\n\n# Linux Kernel Patched For Branch History Injection \"BHI\" Intel CPU\nVulnerability\n\nWritten by Michael Larabel in Linux Security on 9 April 2024 at 02:12 PM EDT.\n12 Comments\n\nDisclosed back in March 2022 was Branch History Injection (BHI) as a new\nSpectre vulnerability affecting Intel and Arm CPUs. Then in July of 2022 were\npatches for Intel working on hardware-based prevention for Spectre-BHI\nattacks. Now two years later the Linux kernel is seeing mitigations added for\nthe native Branch History Injection vulnerability given a new \"Native BHI\"\nvariant.\n\nMerged this Patch Tuesday were Linux kernel patches for helping fend off\nBranch History Injection when paired with updated CPU microcode. Unless I am\noverlooking something or there is some disclosures not yet published, it's not\nclear why these kernel patches were merged today: the Intel Security Center\nhasn't yet shown any new vulnerabilities today, there isn't any new Intel CPU\nmicrocode drop, nor any other new disclosures I've seen today yet around BHI.\n\nLinus Torvalds merged this \"nativebhi\" branch providing this newest CPU\nsecurity vulnerability mitigation. The merge message reads:\n\n> Mitigations for the native BHI hardware vulnerability:\n>\n> Branch History Injection (BHI) attacks may allow a malicious application to\n> influence indirect branch prediction in kernel by poisoning the branch\n> history. eIBRS isolates indirect branch targets in ring0. The BHB can still\n> influence the choice of indirect branch predictor entry, and although branch\n> predictor entries are isolated between modes when eIBRS is enabled, the BHB\n> itself is not isolated between modes.\n>\n> Add mitigations against it either with the help of microcode or with\n> software sequences for the affected CPUs\"\n>\n> [ This also ends up enabling the full mitigation by default despite the\n> system call hardening, because apparently there are other indirect calls\n> that are still sufficiently reachable, and the 'auto' case just isn't\n> hardened enough.\n>\n> We'll have some more inevitable tweaking in the future - Linus ]\n\nThe updated kernel documentation does point to new research motivating this\nBHI mitigation:\n\n> \"Previously the only known real-world BHB attack vector was via unprivileged\n> eBPF. Further research has found attacks that don't require unprivileged\n> eBPF. For a full mitigation against BHB attacks it is recommended to set\n> BHI_DIS_S or use the BHB clearing sequence.\"\n\nThe new code adds a spectre_bhi= boot time option for on/off/auto controls of\nthis Branch History Injection mitigation. The controls affect the hardware BHI\ncontrol and the software BHB clearing sequence. The patches do confirm that\nAMD, Zhaoxin, and Hygon processors are not affected, but seemingly just Intel\nof x86/x86_64 processors.\n\nAs for affected Intel processors, Alder Lake and newer have the BHI_DIS_S\nhardware control to mitigate BHI. Prior to Alder Lake Intel has released a\nsoftware sequence to clear the branch history.\n\nWith the Linux mitigation the branch history is cleared at system call entry\nand VMexit. For now at least branch history is not cleared at interrupt entry\nbut one of the patches do note:\n\n> \"For now, branch history is not cleared at interrupt entry, as malicious\n> applications are not believed to have sufficient control over the registers,\n> since previous register state is cleared at interrupt entry. Researchers\n> continue to poke at this area and it may become necessary to clear at\n> interrupt entry as well in the future.\"\n\nSo as of a short time ago the Intel BHI mitigation code is merged to Git for\nLinux 6.9 and will be back-ported to stable kernel releases shortly. I'm still\npoking around to find out more information on why the BHI mitigation is now\nhappening two years after the original BHI disclosure.\n\nUPDATE: VUSec.net has now published the details of their new \"Native BHI\"\nresearch on Branch History Injection. They explain:\n\n> In our prior work, we demonstrated that Spectre-V2 attacks were still\n> possible in the kernel through Branch History Injection (BHI), and used eBPF\n> to craft a Spectre disclosure gadget (or simply Spectre gadget for\n> simplicity). In response, vendors suggested disabling unprivileged eBPF.\n> This mitigation left us with a dangling question: \"Is finding 'native'\n> Spectre gadgets for BHI, i.e., not implanted through eBPF, feasible?\"\n>\n> To address this question, we developed InSpectre Gadget. With this tool, we\n> can analyze Spectre gadgets and reason about their (advanced)\n> exploitability. Our efforts led to the discovery of 1,511 Spectre gadgets\n> and 2,105 so-called \ufffddispatch gadgets\ufffd. The latter are very useful for an\n> attacker, as they can be used to chain gadgets and direct speculation\n> towards a Spectre gadget.\n>\n> As the number of gadgets we found point to a nontrivial attack surface,\n> vendors are now recommending to mitigate Native BHI by enabling hardware\n> mitigations and, for older CPUs, software mitigations.\n>\n> From the many gadgets we discovered, we selected one and crafted an end-to-\n> end Native (eBPF=off) BHI exploit.\n\nAMD has also confirmed their processors are not impacted by Native BHI /\nInSpectre Gadget.\n\nNative BHI has been designated CVE-2024-2201 and VUSec has demonstrated the\nvulnerability on a 13th Gen Core CPU while they say all Intel CPUs are\naffected by Native BHI.\n\n12 Comments\n\nRelated News\n\nGitHub Disables The XZ Repository Following Today's Malicious Disclosure\n\nXZ Struck By Malicious Code That Could Allow Unauthorized Remote System Access\n\nLinux 6.9 Sees Further Security Hardening\n\nGhostRace Detailed - Speculative Race Conditions Affecting All Major CPUs /\nISAs\n\nLinux 6.9 Making It Easier Managing Security Mitigation Options\n\n\"SandBox Mode\" Proposed For The Linux Kernel To Improve Memory Safety\n\nAbout The Author\n\nMichael Larabel is the principal author of Phoronix.com and founded the site\nin 2004 with a focus on enriching the Linux hardware experience. Michael has\nwritten more than 20,000 articles covering the state of Linux hardware\nsupport, Linux performance, graphics drivers, and other topics. Michael is\nalso the lead developer of the Phoronix Test Suite, Phoromatic, and\nOpenBenchmarking.org automated benchmarking software. He can be followed via\nTwitter, LinkedIn, or contacted via MichaelLarabel.com.\n\nPopular News This Week\n\nGCC 14 Boasts Nice ASCII Art For Visualizing Buffer Overflows\n\nUbuntu 24.04 Beta Delayed Due To XZ Nightmare\n\nFedora 42 Change Proposal Wants To Make KDE Plasma The Default Over GNOME\n\nAMD's Longtime Open-Source Linux Graphics Driver Advocate Retires\n\nNetplan 1.0 Is Ready To Go For Ubuntu 24.04 LTS\n\nKDE On The Importance Of Wayland Explicit Sync\n\nAMD Says They'll Be Open-Sourcing More Of Their GPU Software Stack & Hardware\nDocs\n\nx86-64-v5? Questions Arise Over The Future Of x86-64 Micro-Architecture\nFeature Levels\n\nLatest Linux News\n\nUPower 1.90.4 Fixes Excessive Disk Writes & High CPU Usage\n\nLinux Kernel Patched For Branch History Injection \"BHI\" Intel CPU\nVulnerability\n\nSiFive HiFive Premier P550 Announced As New RISC-V Developer Board\n\nGoogle Announces Axion ARM-Based CPUs For The Cloud\n\nOpenSSL 3.3 Released With Many Additions For QUIC, CPU Performance\nOptimizations\n\nNouveau/NVK Driver Lands NIL Library Rewrite In Rust For Mesa 24.1\n\nExplicit GPU Synchronization Merged For XWayland\n\nLinux Mint Aims For More Reliable & Faster Repository Access\n\nFESCo Approves The Fedora 41 Switch To DNF5\n\nLinux 6.10 AES-XTS For Disk/File Encryption As Much As ~155% Faster For AMD\nZen 4 CPUs\n\nShow Your Support, Go Premium\n\nPhoronix Premium allows ad-free access to the site, multi-page articles on a\nsingle page, and other features while supporting this site's continued\noperations.\n\nLatest Featured Articles\n\nIntel Announces Gaudi 3 AI Accelerator, Intel Xeon 6 Brand\n\nAMD Radeon Linux Gaming Performance At Parity Between KDE Plasma 6.0 X11 vs.\nWayland\n\nIntel Xeon Max Sees Some Performance Gains For OpenVINO & ONNX With Linux 6.9\n\nCrucial T705 PCIe 5.0 NVMe SSD On Linux\n\nTUXEDO Pulse 14 Gen 3 Continues Running Well As A Powerful AMD Ryzen 7 Linux\nLaptop\n\nSupport Phoronix\n\nThe mission at Phoronix since 2004 has centered around enriching the Linux\nhardware experience. In addition to supporting our site through\nadvertisements, you can help by subscribing to Phoronix Premium. You can also\ncontribute to Phoronix through a PayPal tip or tip via Stripe.\n\nPhoronix Media\n\n  * Contact\n  * Michael Larabel\n  * OpenBenchmarking.org\n\nPhoronix Premium\n\n  * Support Phoronix\n  * While Having Ad-Free Browsing,\n  * Single-Page Article Viewing\n\nShare\n\n  * Facebook\n  * Twitter\n\n  * Legal Disclaimer, Privacy Policy, Cookies | | Contact\n\n  * Copyright \u00a9 2004 - 2024 by Phoronix Media.\n\n  * All trademarks used are properties of their respective owners. All rights reserved.\n\n", "frontpage": false}
