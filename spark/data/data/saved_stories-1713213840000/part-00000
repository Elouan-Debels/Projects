{"aid": "40041198", "title": "Building a GPS receiver", "url": "https://axleos.com/building-a-gps-receiver-part-1-hearing-whispers/", "domain": "axleos.com", "votes": 13, "user": "codyd51", "posted_at": "2024-04-15 14:42:10", "comments": 4, "source_title": "Building a GPS Receiver, Part 1: Hearing Whispers", "source_text": "Building a GPS Receiver, Part 1: Hearing Whispers | Phillip Tennen\n\n## Phillip Tennen\n\n# Building a GPS Receiver, Part 1: Hearing Whispers\n\n15 Apr, 2024 Reading time: 11 minutes\n\nIn this 4-part series I build gypsum, a from-scratch GPS receiver.\n\n  * \u21b3 Part 1: Hearing Whispers\n  * \u21b3 Part 2: Tracking Pinpricks\n  * \u21b3 Part 3: Juggling Signals\n  * \u21b3 Part 4: Measuring Twice\n\n### gypsum's web dashboard\n\n### visualizations from this series\n\n## Table of contents\n\n## Introduction\n\nHave you ever noticed that your Maps app still works during a flight? It can\nfeel illicit, like someone just forgot to turn off the signal, and that\nwatching yourself crawl along the earth should be done without drawing undue\nattention.\n\nA few months ago I learned that there were only around 30 GPS satellites\nserving the entire planet. This piqued my interest, because it reminded me of\nthe 13 root DNS servers from which all resolution flows. Perhaps GPS has a\nsimilar design in which the \u2018source of truth\u2019 is diluted by several layers of\nsignal repeaters?\n\nI navigated to gps.gov, and was presented with this delightful image. I became\neven more excited to learn about what these satellites do!\n\nI decided to try my hand at decoding these GPS signals, guided by the vague\nend-goal of plucking out my position from peanuts.\n\nI learned that the GPS signals that facilitate our mapping apps are ever-\npresent, around us at any altitude, in any weather conditions, at all times.\n\nThis sounds cool in the abstract, but the tangible reality is staggering.\nThese signals are all around me as I write this. They\u2019re all around you as you\nread it. The world is soaked in these whispers, repeating themselves endlessly\nfor anyone willing to listen.\n\nYou can find out exactly where you are, from thin air, anywhere at any time,\nby learning to speak the language of the electromagnetic waves flowing over\nyour skin. These waves have been a constant and quiet companion for most\npeople\u2019s entire lives^\u2731.\n\n##### \u2731 Note\n\nGPS was launched in 1978, which was 45 years ago at time of writing. Five\nbillion people are currently under 40 years old, so well over half the world\u2019s\npopulation has never existed in an environment but this.\n\nGPS is perhaps one of the most audacious geo-engineering feats ever\nundertaken, and its traces can be felt with just an antenna and a motive.\n\n## Quiet beacons\n\nAll that said, it\u2019s not as though there\u2019s a cacophony of navigation data\nswarming around you, deafening if you could just hear it. In reality, the GPS\nsignals surrounding you are astoundingly weak. To take an analogy: imagine a\nnormal light bulb, like the one that might be above you now. Pull it twenty\nthousand kilometers away from the room you\u2019re in, and have it flash, on, off,\non, off, a million times a second. Imagine straining your eye to watch the\nshimmer of the bulb, two Earths away, and listen to what it\u2019s telling you.\n\nBig reveal: this is not hyperbole! The signal pumped out by GPS satellites\nactually has the same strength as a residential lightbulb at the satellite. By\nthe time the flash gets to you, it\u2019s unfathomably attenuated, and yet it can\nstill be detected, decoded, understood and made useful. It\u2019s really\nincredible, and hard to believe without wrangling the data yourself.\n\nThese quiet lighthouses give rise to one of the interesting characteristics of\nGPS: there\u2019s no way for anyone to charge for access to it. No one even knows\nyou\u2019re listening. From the satellite\u2019s perspective, GPS is send-and-forget^\u2731.\n\n##### \u2731 Note\n\nFM radio and broadcast television share this feature.\n\nSimilarly, your GPS location could never be served up to you by a web service.\nThe key idea with server-side computing is that compute might need to be\nserved in one place (such as on a user\u2019s machine), but it\u2019s really no problem\nif it\u2019s computed in another (such as a data center). GPS, by contrast, is\nfundamentally incompatible with this optimization: GPS only tells you about\nthe radio waves hitting where you are, and you need to listen to what\u2019s in the\nfield around you. No datacenter can listen on your behalf.\n\n## Listening closely\n\nOK, you\u2019ve got me, I\u2019m pumped! How do we, uh, listen?\n\nI understand that GPS is transmitted over EM waves, but I don\u2019t know much\nabout the analog domain \u2013 is this the same thing as radio?\n\nGreat! I know that frequency is important, where does that come in?\n\nCool. I know I\u2019m going to write some software to receive these signals, post-\nprocess them, and make a snazzy demo for my pitch deck. I figure this means\nI\u2019ll need to buy a receiver that can tune to the GPS frequency. After\nsearching around for a tunable RF receiver, I learn that I\u2019m looking for a\n\u2018software defined radio\u2019. This sounds reasonable!\n\nI hastily research SDRs and purchase one just before my flight takes off.\n\nI set up SDR++ and start poking around. For a while, I can\u2019t find much of\nanything, but after speedrunning terms such as bias tee^\u2731, AGC^\u2731, and IQ\ncorrection^\u2731, I\u2019m ready to go to town exploring the spectrum.\n\n##### \u2731 Note\n\nA bias tee is a circuit within an SDR that provides DC power to an antenna,\ntraditionally connected to the SDR over SMA. My SDR disables its bias tee by\ndefault, so I needed to turn it on manually so that the antenna received\npower.\n\n##### \u2731 Note\n\nAutomatic gain control is a hardware circuit, or software feature, that\namplifies weak signals in an effort to improve the signal-to-noise ratio (SNR)\nof the received data.\n\n##### \u2731 Note\n\nSDRs output \u2018IQ samples\u2019. I refers to the in-phase part of the signal, and Q\nrefers to the quadrature (or imaginary) part of the signal. I don\u2019t really\nunderstand all the ways in which this is super useful, but my understanding is\nthat this scheme allows you to process the signal in \u201c3D\u201d (time, amplitude,\nand polarity) instead of just in \u201c2D\u201d (time and amplitude).\n\nDue to the circuitry of an SDR, there\u2019s a large frequency spike at whichever\nfrequency you\u2019ve asked the radio to tune itself to. This can be quite\nconfusing as a beginner, as it looks like there\u2019s a strong signal anywhere you\nchoose to look! Although this spike is an unavoidable artifact of how the SDR\nfunctions, there are a few ways to remove it from your collected data. One of\nthese is to tune the radio slightly \u2019to the side\u2019 of the frequency you\u2019d\nactually like to measure, so that the center spike isn\u2019t polluting your real\nsignal. Another, which is a bit less fiddly, is to use some software to detect\nand try to remove this spike at the centered frequency. This feature is called\nIQ correction, presumably because it works by mucking about with the IQ\nsamples before delivering them to the rest of the stack.\n\n## Locking on\n\nBy the time it\u2019s received by terrestrial antennas, the GPS signal is so weak\nthat it has 100,000 times less power than the ambient energy and signals just\nfloating around the place. In other words, the GPS signals can sit up to 50db\nbelow the thermal noise floor^\u2731.\n\n##### \u2731 Note\n\nThe newer GPS satellites are meant to send signals that reach receivers at\naround -130dBm. The typical residential thermal noise floor at the C/A\nbandwidth is about -110dBm.\n\nFor comparison, cell signals are around -50dBm: 100 million times stronger\nthan the GPS signal!\n\nOur signal has been entirely swallowed up by random perturbations far stronger\nthan the signal we\u2019re trying to detect. It seems obviously impossible, then,\nthat any data could be recovered.\n\nIncredibly, the GPS signal can be identified and decoded, despite being far\nbelow the thermal noise floor. GPS accomplishes this through the use of a\nclever signal processing technique that allows a signal to be found even when\nsurrounded by noise.\n\n## Hearing the inaudible\n\nWhen we\u2019re trying to listen to the GPS satellite, there\u2019s an information\nasymmetry: the satellite has data that the receiver doesn\u2019t have, and the\nreceiver wants to hear it. However, the receiver cannot hear such an\nincredibly weak signal in the face of the (comparatively) much louder cymbals\nand crashes of the random signals floating around the surface of the Earth.\n\nSo, GPS uses a trick here. Although there\u2019s unknown data that the GPS\nsatellite sends, we can also have the satellite send a signal that\u2019s known to\nboth the satellite and the receiver. This extra signal, called the C/A^\u2731 code,\nthe PRN code, or the chipping code, is repeated by the satellites a thousand\ntimes a second.\n\n##### \u2731 Note\n\nC/A stands for coarse acquisition, and it exists in contrast to the P, or\nprecision, code. GPS was initially envisioned for military use, and the C/A\ncode was intended to be a low-resolution stepping stone for military receivers\nto lock on to the much more precise P code. Nowadays, the C/A code is the\nbasis for most civilian GPS, whereas the P code is still only available for\nmilitary use.\n\nInterestingly, the only thing stopping civilians from using the P code is the\nknowledge of the value of its chipping sequence. If the formula to generate\nthe P code was publicly known, there\u2019d be nothing stopping civilian GPS\nreceivers from locking on to it, with the exact same techniques as are used\nfor the C/A code.\n\nSimilarly, the only reason the P code is so much more precise than the C/A\ncode is that it operates at a higher chipping rate! As we\u2019ll see later, the\nexact phase of the code is one of the key observations that allow the receiver\nto calculate its distance from the satellite, so a code that transmits more\nfrequently inherently gives a higher distance precision.\n\nSince the receiver knows exactly what to listen for here, the receiver can sum\nthe received signal over and over again and compare the actual signal to the\nPRN signal the receiver is expecting. The noise, being random, will average\ndown to zero over time, while the PRN signal will keep growing and growing^\u2731.\nThis trick is referred to as spread-spectrum. GPS uses a trick-in-a-trick to\nmake this whole thing work with multiple satellites, which is called code-\ndivision multiple access.\n\n##### \u2731 Note\n\nThink about how absolutely absurd this is. GPS receivers listen to white noise\nfrom the floor of your radio, and stack static onto more static over and over\nagain. The GPS satellite signal, emitted in deep space by a tinny little\nlightbulb, shines like a beacon. It\u2019s beautiful, it\u2019s true magic.\n\nNow that we have a way for the receiver to hear the otherwise inaudible PRN,\nthe GPS satellites take the PRN code and \u2018mix\u2019 the actual data signal they\nwant to transmit into it. While the PRN code operates at a million bits per\nsecond, the data signal is transmitted much slower, at 50 bits per second. By\nkeeping the data rate significantly slower than the PRN code, GPS ensures that\nthe PRN code remains a reliable fixture to lock on to for large fractions of a\nsecond, while also ensuring that the data stream can be reliably recovered.\n\n## Generating the C/A codes\n\nWe don\u2019t just have one PRN code, though. There are 30 GPS satellites in the\nsky, and to achieve our eventual goal of figuring out where we are, we\u2019ll need\nto know exactly which of the satellites are above us.\n\nTherefore, each GPS satellite has its own unique, stable PRN code.\n\nThese codes are described by Table 3-I (Code Phase Assignments) of the IS-\nGPS-200L, the civilian GPS specification.\n\nIf you search around, you\u2019ll find a lot of resources online telling you how\neasy it is to generate the PRN codes, and very little by way of actual\nreproductions of the full PRN codes for you to check against.\n\nThese codes are relied upon many millions of times daily, and it makes me wary\nthat I didn\u2019t find them online. I\u2019m leaving them here for posterity. I hope\nthis helps someone!\n\n## Acquisition\n\nTo investigate the sky for the satellites that are in view, GPS receivers need\nto generate a copy of each PRN that\u2019s being emitted by each of the 32\nsatellites, then search for each of these PRNs in the data that the GPS\nreceiver is collecting over its antenna. This phase is called \u2018acquisition\u2019,\nbecause the goal is to \u2018acquire\u2019 a lock on whichever satellites are in view\nabove the user.\n\nOur GPS receiver needs to take a short snapshot of antenna data (a second or\nso will do), and correlate the received data with each of these replica PRNs.\nIf there\u2019s a strong correlation between our replica and the live data, we know\nthat the satellite associated with that PRN is chirping away above us.\n\nHowever, the signals that reach us aren\u2019t the \u2018ideal\u2019 PRNs that we\u2019ve\ngenerated locally. Just like the GPS signals are attenuated due to passing\nthrough Earth\u2019s atmosphere, other physical effects also impact the signal we\nreceive. Since the GPS satellites are transiting so fast above us, the signal\nwe receive from each satellite will be Doppler-shifted in frequency.\n\nSince the GPS satellites transit at well-known orbital velocities, we know the\nrange of Doppler shifts we\u2019d expect the signal to reach us at: up to a +5KHz\nfrequency increase for an approaching satellite, or -5KHz frequency decrease\nfor a satellite travelling away from us.\n\nAlso, since we\u2019ve started listening for the GPS signals at some arbitrary\npoint in time, we might start hearing the PRN halfway through its\ntransmission.\n\nTherefore, when searching the data we\u2019ve received for satellite signals, we\nneed to search across several axes at once:\n\n  1. Each satellite\u2019s PRN code.\n  2. The range of Doppler shifts that we\u2019d expect the PRN code to be slid by.\n  3. The phase that we\u2019ll slide our replica PRN code by to match up with the received PRN code.\n\nThis acquisition phase of the GPS receiver tends to be compute-intensive.\nThankfully, when you do stumble on the correct parameters the correlation\nspike makes things pretty clear!\n\nThere\u2019s a wealth of academic papers out there exploring ideas to speed up and\noptimize acquisition. It\u2019s quite remarkable: some papers are entirely founded\non tweaking the equation in effectively one line of code, and exploring how\nthis impacts the acquisition performance characteristics.\n\nI\u2019m transforming each PRN from the time domain into the frequency domain, and\ncorrelating the frequencies of the incoming satellite data with the spectrums\nof each PRN code. This is really useful because a phase offset in the time\ndomain becomes a shift in frequency components, and what that means is that I\nget to perform steps #2 and #3 in the same computation^\u2731! I\u2019m also using a\nbinary search sort of approach to converge on the Doppler shift that gives the\nstrongest correlation spike for each satellite in view^\u2731.\n\n##### \u2731 Note\n\nThe technical term for what I\u2019m doing here is cross correlation in the\nfrequency domain.\n\n##### \u2731 Note\n\nThe GPS literature is interesting because it contains tons of incredibly dense\nand intricate signal processing and orbital mechanics expertise, interspersed\nwith completely benign software ideas dressed up in fur coats. Typical sources\nrefer to this search over the Doppler space as \u201cfrequency bins\u201d or \u201cfrequency\nbuckets\u201d, and seem to conventionally step over the space in 500Hz and leave it\nat that. Since we\u2019re writing code, it\u2019s easy to binary search here for a\nstronger match - no fancy new nomenclature necessary.\n\nAll said and done, we\u2019ve built a detector to determine which GPS satellites\nare in the sky above us, as well as a rough approximation of their phase (or\ntime delay), and Doppler shift (or relative velocity). We\u2019ve completed the\nfirst major step in the GPS positioning pipeline, and we can now say with\nconfidence which GPS satellites are currently above the user! Read more in\nPart 2: Tracking Pinpricks.\n\n### Newsletter\n\n", "frontpage": true}
